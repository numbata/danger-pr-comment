name: Danger Comment

on:
  workflow_call:
    inputs:
      report-artifact-name:
        description: "Artifact name for the Danger report."
        required: false
        type: string
        default: danger-report
      report-file:
        description: "Report filename produced by Danger."
        required: false
        type: string
        default: danger-report.json
      comment-title:
        description: "Heading for the PR comment."
        required: false
        type: string
        default: "Danger Report"
      comment-marker:
        description: "Unique marker used to update the existing comment."
        required: false
        type: string
        default: "<!-- danger-report -->"

permissions:
  actions: read        # download artifacts
  issues: write        # list + create/update comments
  pull-requests: write # PR comment access

jobs:
  comment:
    runs-on: ubuntu-latest
    steps:
      - name: Download Danger report
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.report-artifact-name }}
          path: report
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN || github.token }}

      - name: Post or update PR comment
        uses: actions/github-script@v7
        env:
          REPORT_PATH: report/${{ inputs.report-file }}
          COMMENT_MARKER: ${{ inputs.comment-marker }}
          COMMENT_TITLE: ${{ inputs.comment-title }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN || github.token }}
          script: |
            const fs = require('fs');

            const marker = process.env.COMMENT_MARKER;
            const title = process.env.COMMENT_TITLE;
            const reportPath = process.env.REPORT_PATH;

            if (!fs.existsSync(reportPath)) {
              core.setFailed(`Report file not found at ${reportPath}`);
              return;
            }

            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            const prNumber = report.pr_number;

            if (!prNumber) {
              core.setFailed('Report did not include pr_number');
              return;
            }

            const sections = [];
            const addList = (label, items) => {
              if (!Array.isArray(items) || items.length === 0) return;
              const lines = items.map(item => `- ${item}`);
              sections.push(`### ${label}\n${lines.join('\n')}`);
            };

            addList('Errors', report.errors);
            addList('Warnings', report.warnings);
            addList('Messages', report.messages);

            if (Array.isArray(report.markdowns) && report.markdowns.length > 0) {
              sections.push(`### Markdowns\n${report.markdowns.join('\n\n')}`);
            }

            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.payload.workflow_run.id}`;
            let body = `${marker}\n## ${title}\n`;

            if (sections.length === 0) {
              body += 'No issues found.\n';
            } else {
              body += `${sections.join('\n\n')}\n`;
            }

            body += `\n[View run](${runUrl})`;

            const { owner, repo } = context.repo;
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: prNumber,
              per_page: 100,
            });

            const existing = comments.find(comment => comment.body && comment.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body,
              });
            }
